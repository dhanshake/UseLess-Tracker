<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker with OCR</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app"></div>

    <script>
        let state = {
            expenses: JSON.parse(localStorage.getItem('expenses') || '[]'),
            formData: {
                date: new Date().toISOString().split('T')[0],
                category: '',
                place: '',
                items: '',
                aud: '',
                paymentMode: '',
                comments: ''
            },
            categories: JSON.parse(localStorage.getItem('categories') || '["Travel", "DayOut", "Recharge", "Utilities", "Rent", "Hospital", "Groceries", "Non Veg"]'),
            paymentModes: JSON.parse(localStorage.getItem('paymentModes') || '["DG-Amex", "DG-CBA", "G-Westpac"]'),
            showAddCategory: false,
            showAddPayment: false,
            newCategory: '',
            newPayment: '',
            notification: '',
            showSettings: false,
            uploadedImage: null,
            isProcessing: false
        };

        function setState(updates) {
            state = { ...state, ...updates };
            
            if (updates.expenses) localStorage.setItem('expenses', JSON.stringify(state.expenses));
            if (updates.categories) localStorage.setItem('categories', JSON.stringify(state.categories));
            if (updates.paymentModes) localStorage.setItem('paymentModes', JSON.stringify(state.paymentModes));
            
            render();
        }

        function showNotification(message) {
            setState({ notification: message });
            setTimeout(() => setState({ notification: '' }), 3000);
        }

        function handleInputChange(e) {
            const { name, value } = e.target;
            setState({ formData: { ...state.formData, [name]: value } });
        }

        // Use google.script.run for Apps Script communication
        function processImageWithOCR(base64Image) {
            setState({ isProcessing: true });
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.status === 'success') {
                        const data = result.data;
                        
                        setState({
                            formData: {
                                ...state.formData,
                                date: data.date || state.formData.date,
                                place: data.place || '',
                                aud: data.aud || '',
                                comments: data.fullText || ''
                            },
                            isProcessing: false
                        });
                        
                        showNotification('‚úÖ Receipt scanned! Please verify the details.');
                    } else {
                        setState({ isProcessing: false });
                        showNotification('‚ùå OCR Error: ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('OCR Error:', error);
                    setState({ isProcessing: false });
                    showNotification('‚ùå Error scanning receipt: ' + error.message);
                })
                .processOCR(base64Image);
        }

        function handleFileUpload(e) {
            const file = e.target.files?.[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const base64Data = event.target.result.split(',')[1];
                setState({ uploadedImage: event.target.result });
                processImageWithOCR(base64Data);
            };
            reader.readAsDataURL(file);
        }

        function handleSubmit(e) {
            e.preventDefault();
            
            if (!state.formData.category || !state.formData.paymentMode || !state.formData.aud) {
                showNotification('‚ùå Please fill in Category, Payment Mode, and Amount');
                return;
            }

            const newExpense = { ...state.formData, id: Date.now() };
            
            showNotification('üíæ Saving to Google Sheets...');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.status === 'success') {
                        showNotification('‚úÖ Saved to Google Sheets!');
                    } else {
                        showNotification('‚ö†Ô∏è Error: ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Save Error:', error);
                    showNotification('‚ö†Ô∏è Error saving: ' + error.message);
                })
                .saveExpense(state.formData);
            
            setState({
                expenses: [newExpense, ...state.expenses],
                formData: {
                    date: new Date().toISOString().split('T')[0],
                    category: '',
                    place: '',
                    items: '',
                    aud: '',
                    paymentMode: '',
                    comments: ''
                },
                uploadedImage: null
            });
        }

        function deleteExpense(id) {
            if (confirm('Delete this expense?')) {
                setState({ expenses: state.expenses.filter(exp => exp.id !== id) });
                showNotification('Expense deleted!');
            }
        }

        function addCategory() {
            if (state.newCategory.trim() && !state.categories.includes(state.newCategory.trim())) {
                setState({
                    categories: [...state.categories, state.newCategory.trim()],
                    newCategory: '',
                    showAddCategory: false
                });
                showNotification('Category added!');
            }
        }

        function addPayment() {
            if (state.newPayment.trim() && !state.paymentModes.includes(state.newPayment.trim())) {
                setState({
                    paymentModes: [...state.paymentModes, state.newPayment.trim()],
                    newPayment: '',
                    showAddPayment: false
                });
                showNotification('Payment mode added!');
            }
        }

        function exportToCSV() {
            const headers = ['Date', 'Category', 'Place', 'Items', 'AUD', 'Payment Mode', 'Comments'];
            const csv = [
                headers.join(','),
                ...state.expenses.map(exp => 
                    [exp.date, exp.category, exp.place, exp.items, exp.aud, exp.paymentMode, exp.comments]
                        .map(v => `"${v}"`)
                        .join(',')
                )
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expenses_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showNotification('üì• CSV exported!');
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è This will delete ALL local expenses. Are you sure?')) {
                localStorage.clear();
                setState({
                    expenses: [],
                    categories: ['Travel', 'DayOut', 'Recharge', 'Utilities', 'Rent', 'Hospital', 'Groceries', 'Non Veg'],
                    paymentModes: ['DG-Amex', 'DG-CBA', 'G-Westpac']
                });
                showNotification('Local data cleared!');
            }
        }

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div class="flex justify-between items-center mb-6">
                                <h1 class="text-3xl font-bold text-gray-800">üí∞ Expense Tracker with OCR</h1>
                                <button onclick="setState({ showSettings: !state.showSettings })" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                                    ‚öôÔ∏è Settings
                                </button>
                            </div>
                            
                            ${state.showSettings ? `
                                <div class="mb-6 p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                                    <h3 class="font-semibold text-gray-800 mb-3">‚öôÔ∏è Settings</h3>
                                    <p class="text-sm text-gray-600 mb-2">‚úÖ OCR powered by Google Vision API (configured in Apps Script)</p>
                                    <p class="text-sm text-gray-600 mb-2">‚úÖ Data saved to Google Sheets automatically</p>
                                    <button onclick="clearAllData()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm mt-2">
                                        üóëÔ∏è Clear Local Data
                                    </button>
                                    <p class="text-xs text-gray-500 mt-2">Local data stored in browser. Google Sheets data is preserved.</p>
                                </div>
                            ` : ''}
                            
                            ${state.notification ? `
                                <div class="mb-4 p-3 bg-green-100 text-green-800 rounded-lg animate-pulse">
                                    ${state.notification}
                                </div>
                            ` : ''}

                            <div class="mb-6 p-4 bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-200 rounded-xl">
                                <h2 class="text-lg font-semibold text-gray-800 mb-3">
                                    üì∏ Smart Receipt Scanner
                                </h2>
                                <p class="text-sm text-gray-600 mb-3">Upload a receipt and let AI extract the details automatically!</p>
                                <div class="flex flex-wrap gap-3">
                                    <label class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white rounded-lg cursor-pointer transition shadow-lg">
                                        <span>ü§ñ Scan Receipt with AI</span>
                                        <input type="file" accept="image/*" onchange="handleFileUpload(event)" class="hidden" />
                                    </label>
                                </div>
                                ${state.uploadedImage ? `
                                    <div class="mt-4">
                                        <img src="${state.uploadedImage}" alt="Receipt" class="w-full max-w-md rounded-lg shadow-lg border-4 border-white" />
                                    </div>
                                ` : ''}
                                ${state.isProcessing ? `
                                    <div class="mt-4 p-4 bg-white rounded-lg border-2 border-blue-500 shadow-lg">
                                        <div class="flex items-center gap-3">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                                            <p class="text-blue-700 font-medium">üîÑ AI is reading your receipt...</p>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <form onsubmit="handleSubmit(event); return false;" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                                        <input type="date" name="date" value="${state.formData.date}" onchange="handleInputChange(event)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required />
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                                        <div class="flex gap-2">
                                            <select name="category" value="${state.formData.category}" onchange="handleInputChange(event)" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                                <option value="">Select category</option>
                                                ${state.categories.map(cat => `<option value="${cat}" ${state.formData.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                            </select>
                                            <button type="button" onclick="setState({ showAddCategory: !state.showAddCategory })" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">‚ûï</button>
                                        </div>
                                        ${state.showAddCategory ? `
                                            <div class="flex gap-2 mt-2">
                                                <input type="text" value="${state.newCategory}" oninput="state.newCategory = this.value" placeholder="New category" class="flex-1 px-3 py-1 border rounded-lg text-sm" />
                                                <button type="button" onclick="addCategory()" class="px-3 py-1 bg-blue-600 text-white rounded-lg text-sm">Add</button>
                                            </div>
                                        ` : ''}
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Place</label>
                                        <input type="text" name="place" value="${state.formData.place}" onchange="handleInputChange(event)" placeholder="e.g., North Sydney" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Items</label>
                                        <input type="text" name="items" value="${state.formData.items}" onchange="handleInputChange(event)" placeholder="e.g., Ofc travel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Amount (AUD) *</label>
                                        <input type="number" name="aud" value="${state.formData.aud}" onchange="handleInputChange(event)" placeholder="0.00" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required />
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Mode *</label>
                                        <div class="flex gap-2">
                                            <select name="paymentMode" value="${state.formData.paymentMode}" onchange="handleInputChange(event)" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                                <option value="">Select payment mode</option>
                                                ${state.paymentModes.map(mode => `<option value="${mode}" ${state.formData.paymentMode === mode ? 'selected' : ''}>${mode}</option>`).join('')}
                                            </select>
                                            <button type="button" onclick="setState({ showAddPayment: !state.showAddPayment })" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">‚ûï</button>
                                        </div>
                                        ${state.showAddPayment ? `
                                            <div class="flex gap-2 mt-2">
                                                <input type="text" value="${state.newPayment}" oninput="state.newPayment = this.value" placeholder="New payment mode" class="flex-1 px-3 py-1 border rounded-lg text-sm" />
                                                <button type="button" onclick="addPayment()" class="px-3 py-1 bg-blue-600 text-white rounded-lg text-sm">Add</button>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Comments</label>
                                    <input type="text" name="comments" value="${state.formData.comments}" onchange="handleInputChange(event)" placeholder="Additional notes" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                                </div>

                                <button type="submit" class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold text-lg">
                                    <span>üíæ Save Expense</span>
                                </button>
                            </form>
                        </div>

                        ${state.expenses.length > 0 ? `
                            <div class="bg-white rounded-2xl shadow-xl p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-bold text-gray-800">Recent Expenses (${state.expenses.length})</h2>
                                    <button onclick="exportToCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                        üì• Export CSV
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Date</th>
                                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Category</th>
                                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Place</th>
                                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Items</th>
                                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">AUD</th>
                                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Payment</th>
                                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${state.expenses.map(exp => `
                                                <tr class="border-t hover:bg-gray-50">
                                                    <td class="px-4 py-2 text-sm">${exp.date}</td>
                                                    <td class="px-4 py-2 text-sm">${exp.category}</td>
                                                    <td class="px-4 py-2 text-sm">${exp.place}</td>
                                                    <td class="px-4 py-2 text-sm">${exp.items}</td>
                                                    <td class="px-4 py-2 text-sm font-semibold">$${exp.aud}</td>
                                                    <td class="px-4 py-2 text-sm">${exp.paymentMode}</td>
                                                    <td class="px-4 py-2 text-sm">
                                                        <button onclick="deleteExpense(${exp.id})" class="text-red-600 hover:text-red-800">üóëÔ∏è</button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4 text-right">
                                    <span class="text-sm font-semibold text-gray-700">Total: $${state.expenses.reduce((sum, exp) => sum + parseFloat(exp.aud || 0), 0).toFixed(2)}</span>
                                </div>
                            </div>
                        ` : `
                            <div class="bg-white rounded-2xl shadow-xl p-12 text-center">
                                <p class="text-gray-500 text-lg">No expenses yet. Scan a receipt to get started! üìù</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        render();
    </script>
</body>
</html>
